<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ماسح الباركود</title>
</head>
<body>
  <h1>ماسح الباركود</h1>
  <label for="attendance">اختر الحضور:</label>
  <select id="attendance">
    <option value="0">الحضور الاول</option>
    <option value="1">الحضور الثاني</option>
    <option value="2">الحضور الثالث</option>
    <!-- Add more options as needed -->
  </select>
  <div id="scanner" style="width: 100%; height: 300px;"></div>
  <p id="result">...waiting for scanning</p>

  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
  <script>
    const scanner = new Html5Qrcode("scanner");
    const scriptURL = "https://script.google.com/macros/s/AKfycbxEokzlvUEP6fGlhQpjytVxR7-gvy9g14vwKYmCTz7M7gfhdGeEIptV0pgKalDRugg/exec";

    Html5Qrcode.getCameras().then((devices) => {
      if (devices && devices.length) {
        scanner.start(
          { facingMode: "environment" }, // Use rear camera
          { fps: 10, qrbox: 250 },
          (decodedText) => {
            // Barcode scanned successfully
            document.getElementById("result").innerText = `Barcode: ${decodedText}`;

            // Get attendance selection
            const attendanceIndex = document.getElementById("attendance").value;

            // Send POST request to Google Apps Script
            fetch(scriptURL, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                barcode: decodedText,
                attendanceIndex: attendanceIndex,
              }),
            })
              .then((response) => response.json())
              .then((data) => {
                if (data.success) {
                  alert("تم تسجيل الحضور بنجاح!");
                } else {
                  alert("خطأ: " + (data.error || "تعذر العثور على الباركود"));
                }
              })
              .catch((error) => alert("فشل الاتصال بالسيرفر: " + error.message));
          },
          (error) => {
            console.error("Scanning error:", error);
          }
        );
      } else {
        alert("لا توجد كاميرا متاحة");
      }
    }).catch((err) => console.error(err));
  </script>
</body>
</html>
